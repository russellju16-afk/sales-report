<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>经营分析&财务分析总报告（首席财务官版）</title>
<link rel="stylesheet" href="./styles.css"/>
</head>
<body class="report-body">
<div id="loading_state" class="state">
  <div class="state-card">
    <div class="state-spinner"></div>
    <div class="state-title">数据加载中…</div>
    <div class="state-msg">正在拉取 ./data/latest.json 与 ./data/finance_latest.json</div>
  </div>
</div>

<div id="error_state" class="state hidden">
  <div class="state-card">
    <div class="state-title">数据加载失败</div>
    <div id="error_message" class="state-msg"></div>
    <button id="reload_btn" class="btn">重新加载</button>
  </div>
</div>

<div id="debug_panel" class="report-debug hidden">
  <div class="report-debug-title">自检面板（debug=1）</div>
  <div class="report-debug-grid">
    <div id="debug_load_time">加载耗时：—</div>
    <div id="debug_data_status">latest.json：—</div>
    <div id="debug_finance_status">finance_latest.json：—</div>
  </div>
  <div class="report-debug-title">缺失字段</div>
  <ul class="report-debug-list" id="debug_missing_list"></ul>
</div>

<div class="report-toolbar" id="report_toolbar">
  <div class="report-toolbar-main">
    <div class="report-title">经营分析&财务分析总报告（首席财务官版）</div>
    <div class="report-meta">
      期间：<b id="meta_period">—</b>
      <span class="report-sep">｜</span>
      生成时间：<b id="meta_generated">—</b>
      <span class="report-sep">｜</span>
      币种：<b id="meta_currency">—</b>
    </div>
  </div>
  <div class="report-toolbar-actions">
    <a class="btn" href="./dashboard.html">打开看板</a>
    <a class="btn" href="./reports/bp_latest.html" target="_blank" rel="noopener">打开预算报告</a>
    <button class="btn" id="export_snapshot_btn">下载本期摘要 JSON</button>
    <button class="btn" id="print_btn">打印</button>
    <button class="btn" id="export_actions_btn">导出动作CSV</button>
    <button class="btn" id="export_warnings_btn">导出预警CSV</button>
    <a class="btn" href="https://github.com/russellju16-afk/sales-report" target="_blank" rel="noopener">打开仓库/反馈</a>
  </div>
</div>

<div class="report-layout">
  <aside class="report-toc" id="report_toc">
    <div class="toc-title">目录</div>
    <a href="#sec-0">0 口径&数据范围&对账声明</a>
    <a href="#sec-1">1 经营摘要</a>
    <a href="#sec-2">2 收入与毛利</a>
    <a href="#sec-3">3 现金流与收付匹配</a>
    <a href="#sec-4">4 经营性应收</a>
    <a href="#sec-5">5 其他应收（专项清理）</a>
    <a href="#sec-6">6 经营性应付</a>
    <a href="#sec-7">7 其他应付（专项清理）</a>
    <a href="#sec-8">8 库存与周转</a>
    <a href="#sec-9">9 采购与价格</a>
    <a href="#sec-10">10 风险预警中心</a>
    <a href="#sec-11">11 动作清单</a>
  </aside>

  <main class="report-main">
    <section id="sec-0" class="report-section">
      <div class="section-head">
        <h2>0 口径&数据范围&对账声明</h2>
        <div class="section-meta" id="sec0_meta"></div>
      </div>

      <div class="report-grid report-grid-3">
        <div class="card report-card">
          <div class="report-card-title">口径与数据范围</div>
          <ul class="report-list">
            <li>期间：<b id="meta_range">—</b></li>
            <li>销售版本：<b id="meta_sales_version">—</b></li>
            <li>财务版本：<b id="meta_finance_version">—</b></li>
            <li>币种：<b id="meta_currency_2">—</b></li>
          </ul>
        </div>
        <div class="card report-card">
          <div class="report-card-title">指标体系</div>
          <ul class="report-list">
            <li>增长：销售额 / 毛利 / 毛利-销售费</li>
            <li>效率：应收周转天数 / 应付周转天数 / 存货周转天数 / 现金转换周期</li>
            <li>规模：应收 / 应付 / 库存余额</li>
            <li>结构：客户 / 品类 / 产品贡献与集中度</li>
            <li>现金：净现金流与收付匹配</li>
          </ul>
        </div>
        <div class="card report-card">
          <div class="report-card-title">分析链路</div>
          <ol class="report-steps">
            <li>确认口径 → 对齐期间与币种</li>
            <li>收入与毛利 → 结构与异常拆解</li>
            <li>现金流 → 收付匹配与对账差异</li>
            <li>周转效率 → 应收/应付/库存</li>
            <li>风险预警 → 诊断 → 动作闭环</li>
          </ol>
        </div>
      </div>

      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">对账声明</div>
          <ul class="report-list" id="meta_notes_list">
            <li>加载中…</li>
          </ul>
        </div>
        <div class="card report-card">
          <div class="report-card-title">结论模板（强制）</div>
          <div class="report-template">
            <div>结论：一句话说明偏差/风险/机会。</div>
            <div>证据：指标/数据点 + 对比/阈值。</div>
            <div>动作：负责人 / 做什么 / DDL / 预期影响。</div>
          </div>
        </div>
      </div>

      <details class="report-detail" open>
        <summary>诊断树（通用）</summary>
        <div class="diag-tree">
          <div>现金流异常 → 收入下降 / 回款延迟 / 付款集中</div>
          <div>毛利下滑 → 价格下行 / 成本上升 / 费用抬升</div>
          <div>周转变慢 → 应收集中 / 付款过慢 / 库存积压</div>
          <div>集中度过高 → 客户/供应商备份不足</div>
        </div>
      </details>

      <details class="report-detail">
        <summary>口径&阈值（可折叠）</summary>
        <ul class="report-list" id="threshold_list">
          <li>加载中…</li>
        </ul>
      </details>

      <div class="report-conclusion-grid" id="sec0_conclusions"></div>
    </section>

    <section id="sec-1" class="report-section">
      <div class="section-head">
        <h2>1 经营摘要</h2>
        <div class="section-meta">16~20 个关键指标 + 预警灯 + 本期5条关键结论</div>
      </div>
      <div class="kpis report-kpis" id="exec_kpis"></div>
      <div class="report-grid report-grid-2 report-exec-grid">
        <div class="card report-card" id="warning_traffic_panel">
          <div class="report-card-title">红黄绿灯（点击跳转预警中心）</div>
          <div class="report-traffic">
            <button class="report-traffic-item level-red" id="traffic_red">
              <span class="traffic-label">红</span>
              <b id="traffic_red_count">—</b>
            </button>
            <button class="report-traffic-item level-yellow" id="traffic_yellow">
              <span class="traffic-label">黄</span>
              <b id="traffic_yellow_count">—</b>
            </button>
            <button class="report-traffic-item level-green" id="traffic_green">
              <span class="traffic-label">绿</span>
              <b id="traffic_green_count">—</b>
            </button>
          </div>
          <div class="report-mini-note">点击任意灯号自动滚动到预警中心。</div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">分部对比矩阵（全部/门店/非门店）</div>
          <div class="table-wrap dense-table">
            <div class="table-scroll report-table-scroll">
              <table id="segment_matrix_table">
                <thead><tr>
                  <th>分部</th>
                  <th>销售额</th>
                  <th>毛利额</th>
                  <th>毛利率</th>
                  <th>净现金流</th>
                  <th>净应收</th>
                  <th>净应付</th>
                  <th>库存</th>
                  <th>应收周转天数</th>
                  <th>应付周转天数</th>
                  <th>存货周转天数</th>
                  <th>现金转换周期</th>
                  <th>第一名集中度</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="report-subhead">本期5条关键结论</div>
      <div class="report-conclusion-grid" id="exec_conclusions"></div>
    </section>

    <section id="sec-2" class="report-section">
      <div class="section-head">
        <h2>2 收入与毛利</h2>
        <div class="section-meta">趋势 / 结构 / 异常订单</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">销售与毛利趋势</div>
          <div id="sales_trend_chart" class="plot-sm report-plot"></div>
          <div class="report-mini-note" id="sales_mom_text">加载中…</div>
          <div id="sales_mom_bridge" class="plot-xs report-plot"></div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">结构贡献头部</div>
          <div class="report-mini-tables">
            <div class="table-wrap dense-table">
              <div class="report-table-title">头部品类</div>
              <div class="table-scroll report-table-scroll">
                <table id="sales_top_categories_table">
                  <thead><tr>
                    <th>品类</th>
                    <th>销售额</th>
                    <th>占比</th>
                    <th>毛利率</th>
                    <th>扣费毛利率</th>
                  </tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="table-wrap dense-table">
              <div class="report-table-title">头部客户</div>
              <div class="table-scroll report-table-scroll">
                <table id="sales_top_customers_table">
                  <thead><tr>
                    <th>客户</th>
                    <th>销售额</th>
                    <th>占比</th>
                    <th>毛利率</th>
                    <th>扣费毛利率</th>
                  </tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="table-wrap dense-table">
              <div class="report-table-title">头部产品</div>
              <div class="table-scroll report-table-scroll">
                <table id="sales_top_products_table">
                  <thead><tr>
                    <th>产品</th>
                    <th>销售额</th>
                    <th>占比</th>
                    <th>毛利率</th>
                    <th>扣费毛利率</th>
                  </tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec2_conclusions"></div>
    </section>

    <section id="sec-3" class="report-section">
      <div class="section-head">
        <h2>3 现金流与收付匹配</h2>
        <div class="section-meta">银行维度 / 对账差异</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">期间现金流概览</div>
          <div class="report-kpi-row" id="cash_kpis"></div>
          <div id="cash_trend_chart" class="plot-sm report-plot"></div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">银行维度汇总</div>
          <div class="table-wrap dense-table">
            <div class="table-scroll report-table-scroll">
              <table id="bank_type_table">
                <thead><tr>
                  <th>类型</th>
                  <th>流入</th>
                  <th>流出</th>
                  <th>笔数</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="report-recon">
            <div class="report-mini-card" id="bank_recon_receipts"></div>
            <div class="report-mini-card" id="bank_recon_payments"></div>
          </div>
          <div class="report-recon-explain" id="bank_recon_explain">加载中…</div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec3_conclusions"></div>
    </section>

    <section id="sec-4" class="report-section">
      <div class="section-head">
        <h2>4 经营性应收</h2>
        <div class="section-meta">应收周转天数 / 集中度 / 停滞</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">应收指标</div>
          <div class="report-kpi-row" id="ar_kpis"></div>
          <div id="ar_trend_chart" class="plot-sm report-plot"></div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">头部客户（贸易应收）</div>
          <div class="table-wrap dense-table">
            <div class="table-scroll report-table-scroll">
              <table id="ar_top_customers_table">
                <thead><tr>
                  <th>客户</th>
                  <th>期末贸易应收</th>
                  <th>期末净应收</th>
                  <th>占比</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec4_conclusions"></div>
    </section>

    <section id="sec-5" class="report-section">
      <div class="section-head">
        <h2>5 其他应收（专项清理）</h2>
        <div class="section-meta">单列专项，不参与应收周转天数</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">原因分类模板</div>
          <div class="report-template">押金 / 往来 / 返利 / 代垫 / 员工借款 / 费用暂挂 / 其他</div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">清理路径</div>
          <div class="report-template">对账 → 确认 → 回收/冲抵 → 转长期/核销 → 月度跟踪</div>
        </div>
      </div>
      <div class="card report-card">
        <div class="report-card-title">头部其他应收客户</div>
        <div class="table-wrap dense-table">
          <div class="table-scroll report-table-scroll">
            <table id="other_ar_table">
              <thead><tr>
                <th>客户</th>
                <th>其他应收余额</th>
                <th>期末应收净额</th>
                <th>动作建议</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec5_conclusions"></div>
    </section>

    <section id="sec-6" class="report-section">
      <div class="section-head">
        <h2>6 经营性应付</h2>
        <div class="section-meta">应付周转天数 / 集中度 / 停滞</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">应付指标</div>
          <div class="report-kpi-row" id="ap_kpis"></div>
          <div id="ap_trend_chart" class="plot-sm report-plot"></div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">头部供应商（采购应付）</div>
          <div class="table-wrap dense-table">
            <div class="table-scroll report-table-scroll">
              <table id="ap_top_suppliers_table">
                <thead><tr>
                  <th>供应商</th>
                  <th>采购应付余额</th>
                  <th>期末应付净额</th>
                  <th>占比</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec6_conclusions"></div>
    </section>

    <section id="sec-7" class="report-section">
      <div class="section-head">
        <h2>7 其他应付（专项清理）</h2>
        <div class="section-meta">单列专项，不参与应付周转天数</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">原因分类模板</div>
          <div class="report-template">押金 / 往来 / 返利 / 代垫 / 员工借款 / 费用暂挂 / 其他</div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">清理路径</div>
          <div class="report-template">对账 → 确认 → 冲抵/支付 → 转长期/核销 → 月度跟踪</div>
        </div>
      </div>
      <div class="card report-card">
        <div class="report-card-title">头部其他应付供应商</div>
        <div class="table-wrap dense-table">
          <div class="table-scroll report-table-scroll">
            <table id="other_ap_table">
              <thead><tr>
                <th>供应商</th>
                <th>其他应付余额</th>
                <th>期末应付净额</th>
                <th>动作建议</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec7_conclusions"></div>
    </section>

    <section id="sec-8" class="report-section">
      <div class="section-head">
        <h2>8 库存与周转</h2>
        <div class="section-meta">存货周转天数 / 结构 / 滞销</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">库存指标</div>
          <div class="report-kpi-row" id="inventory_kpis"></div>
          <div id="inventory_trend_chart" class="plot-sm report-plot"></div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">库存诊断重点</div>
          <div class="report-text" id="inventory_focus">加载中…</div>
          <details class="report-detail" open>
            <summary>诊断树</summary>
            <div class="diag-tree">
              <div>销量下降 → 需求滑落 / 价格偏离 / 客群变化</div>
              <div>库存上升 → 采购节奏不匹配 / 滞销货号未清理</div>
              <div>周转变慢 → 资金占用加剧 / 现金流承压</div>
            </div>
          </details>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec8_conclusions"></div>
    </section>

    <section id="sec-9" class="report-section">
      <div class="section-head">
        <h2>9 采购与价格</h2>
        <div class="section-meta">采购单 / 成本趋势</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">采购指标</div>
          <div class="report-kpi-row" id="po_kpis"></div>
          <div class="report-card-title" id="po_price_title">关键货号价格走势</div>
          <div id="po_price_chart" class="plot-sm report-plot"></div>
        </div>
        <div class="card report-card">
          <div class="report-card-title">头部供应商（采购额）</div>
          <div class="table-wrap dense-table">
            <div class="table-scroll report-table-scroll">
              <table id="po_top_suppliers_table">
                <thead><tr>
                  <th>供应商</th>
                  <th>采购金额</th>
                  <th>占比</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="report-mini-note">价格趋势默认展示采购额最高的货号。</div>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec9_conclusions"></div>
    </section>

    <section id="sec-10" class="report-section">
      <div class="section-head">
        <h2>10 风险预警中心</h2>
        <div class="section-meta">规则引擎 + 诊断树</div>
      </div>
      <div class="report-grid report-grid-2">
        <div class="card report-card">
          <div class="report-card-title">规则引擎阈值</div>
          <ul class="report-list" id="warning_rules">
            <li>加载中…</li>
          </ul>
        </div>
        <div class="card report-card">
          <div class="report-card-title">预警统计</div>
          <div class="report-text" id="warning_stats">加载中…</div>
          <details class="report-detail" open>
            <summary>诊断树（模板）</summary>
            <div class="diag-tree">
              <div>红色预警 → 现金/周转已冲击经营</div>
              <div>黄色预警 → 指标偏离需重点跟踪</div>
              <div>绿色预警 → 维持监控节奏</div>
            </div>
          </details>
        </div>
      </div>
      <div class="report-warning-filters">
        <label class="ctl">等级：
          <select id="warning_filter_level">
            <option value="all">全部</option>
            <option value="red">仅红</option>
            <option value="yellow">仅黄</option>
            <option value="green">仅绿</option>
          </select>
        </label>
        <label class="ctl">领域：
          <select id="warning_filter_domain">
            <option value="all">全部</option>
          </select>
        </label>
        <button class="btn btn-sm" id="warning_filter_reset">重置</button>
      </div>
      <div class="table-wrap dense-table">
        <div class="report-table-title">预警清单</div>
        <div class="table-scroll report-table-scroll">
          <table id="warning_table">
            <thead><tr>
              <th>等级</th>
              <th>领域</th>
              <th>信号</th>
              <th>证据</th>
              <th>动作</th>
              <th>证据链接</th>
              <th>诊断树</th>
            </tr></thead>
            <tbody id="warning_table_body"></tbody>
          </table>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec10_conclusions"></div>
    </section>

    <section id="sec-11" class="report-section">
      <div class="section-head">
        <h2>11 动作清单</h2>
        <div class="section-meta">动作跟踪（自动汇总）</div>
      </div>
      <div class="report-action-toolbar">
        <button class="btn" id="copy_actions_btn">复制动作清单</button>
        <button class="btn" id="copy_warnings_btn">复制预警清单</button>
        <span class="report-mini-note" id="action_stats">加载中…</span>
      </div>
      <div class="table-wrap dense-table">
        <div class="table-scroll report-table-scroll">
          <table id="action_table">
            <thead><tr>
              <th>来源</th>
              <th>领域</th>
              <th>结论/信号</th>
              <th>负责人</th>
              <th>动作</th>
              <th>DDL</th>
              <th>预期影响</th>
              <th>证据链接</th>
            </tr></thead>
            <tbody id="action_table_body"></tbody>
          </table>
        </div>
      </div>
      <div class="report-conclusion-grid" id="sec11_conclusions"></div>
    </section>
  </main>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" defer></script>
<script src="./js/report.js" defer></script>
</body>
</html>
