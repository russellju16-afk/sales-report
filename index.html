<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>经营分析&财务分析总报告</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="report-body" data-route="report">
  <div id="loading_state" class="state">
    <div class="state-card">
      <div class="state-spinner"></div>
      <div class="state-title">数据加载中…</div>
      <div class="state-msg">正在拉取经营数据 / 财务数据 / 预测数据</div>
    </div>
  </div>

  <div id="error_state" class="state hidden">
    <div class="state-card">
      <div class="state-title">数据加载失败</div>
      <div id="error_message" class="state-msg"></div>
      <button id="reload_btn" class="btn">重新加载</button>
    </div>
  </div>

  <div class="app-shell">
    <aside class="report-toc" id="global_toc">
      <div class="toc-title">CFO Analysis</div>
      <div class="toc-routes">
        <button class="toc-route btn-nav active" data-route="report">
          <span class="icon">📊</span> 重点摘要
        </button>
        <button class="toc-route btn-nav" data-route="diagnose">
          <span class="icon">🩺</span> 经营诊断
        </button>
        <button class="toc-route btn-nav" data-route="explorer">
          <span class="icon">🔍</span> 明细探索
        </button>
        <button class="toc-route btn-nav" data-route="bp">
          <span class="icon">📈</span> BP 报告
        </button>
      </div>

      <div class="toc-group" data-route="report">
        <div class="toc-group-title">Home</div>
        <a href="#sec-1" data-route="report" data-anchor="sec-1">Executive Summary</a>
        <a href="#sec-risk" data-route="report" data-anchor="sec-risk">Risk Center</a>
        <a href="#sec-10" data-route="report" data-anchor="sec-10">预警中心</a>
        <a href="#sec-11" data-route="report" data-anchor="sec-11">Action Tracker</a>
      </div>
      <div class="toc-group" data-route="diagnose">
        <div class="toc-group-title">Diagnose</div>
        <a href="#sec-2" data-route="diagnose" data-anchor="sec-2">收入与毛利</a>
        <a href="#sec-3" data-route="diagnose" data-anchor="sec-3">现金流与收付</a>
        <a href="#sec-forecast" data-route="diagnose" data-anchor="sec-forecast">预测与压力</a>
        <a href="#sec-4" data-route="diagnose" data-anchor="sec-4">经营性应收</a>
        <a href="#sec-6" data-route="diagnose" data-anchor="sec-6">经营性应付</a>
        <a href="#sec-8" data-route="diagnose" data-anchor="sec-8">库存与周转</a>
      </div>
      <div class="toc-group" data-route="explorer">
        <div class="toc-group-title">Explorer</div>
        <a href="#explorer_root" data-route="explorer" data-anchor="explorer_root">总览</a>
        <a href="#explorer_sales" data-route="explorer" data-anchor="explorer_sales">Sales Explorer</a>
        <a href="#explorer_finance" data-route="explorer" data-anchor="explorer_finance">Finance Explorer</a>
      </div>
    </aside>

    <main class="report-main" id="app_main">
      <div class="main-scroll">
        <header class="command-bar" id="command_bar">
          <div class="command-main">
            <div class="command-title">CFO 经营分析系统</div>
            <div class="command-meta">
              期间：<b id="meta_period">—</b>
              <span class="sep">|</span>
              币种：<b id="meta_currency">—</b>
            </div>
          </div>
          <div class="command-tools">
            <div class="command-search">
              <input id="global_search" type="search" placeholder="搜索结论 / 风险 / BP…" />
            </div>
            <div class="command-actions">
              <button class="btn primary" id="export_center_btn">导出中心</button>
              <button class="btn" id="print_btn">打印摘要</button>
              <button class="btn btn-ghost" id="drawer_toggle_btn">证据抽屉</button>
            </div>
          </div>
        </header>
        <section id="sec-0" class="report-section" data-route="report">
          <div class="section-head">
            <h2>0 口径&数据范围&对账声明</h2>
            <div class="section-meta" id="sec0_meta"></div>
          </div>

          <div class="report-grid report-grid-3">
            <div class="card report-card">
              <div class="report-card-title">口径与数据范围</div>
              <ul class="report-list">
                <li>期间：<b id="meta_range">—</b></li>
                <li>销售版本：<b id="meta_sales_version">—</b></li>
                <li>财务版本：<b id="meta_finance_version">—</b></li>
                <li>币种：<b id="meta_currency_2">—</b></li>
              </ul>
            </div>
            <div class="card report-card">
              <div class="report-card-title">指标体系</div>
              <ul class="report-list">
                <li>增长：销售额 / 毛利 / 毛利-销售费</li>
                <li>效率：应收周转天数 / 应付周转天数 / 存货周转天数 / 现金转换周期</li>
                <li>规模：应收 / 应付 / 库存余额</li>
                <li>结构：客户 / 品类 / 产品贡献与集中度</li>
                <li>现金：净现金流与收付匹配</li>
              </ul>
            </div>
            <div class="card report-card">
              <div class="report-card-title">分析链路</div>
              <ol class="report-steps">
                <li>确认口径 → 对齐期间与币种</li>
                <li>收入与毛利 → 结构与异常拆解</li>
                <li>现金流 → 收付匹配与对账差异</li>
                <li>周转效率 → 应收/应付/库存</li>
                <li>风险预警 → 诊断 → 动作闭环</li>
              </ol>
            </div>
          </div>

          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">对账声明</div>
              <ul class="report-list" id="meta_notes_list">
                <li>加载中…</li>
              </ul>
            </div>
            <div class="card report-card">
              <div class="report-card-title">结论模板（强制）</div>
              <div class="report-template">
                <div>结论：一句话说明偏差/风险/机会。</div>
                <div>证据：指标/数据点 + 对比/阈值。</div>
                <div>动作：负责人 / 做什么 / 截止日期 / 预期影响。</div>
              </div>
            </div>
          </div>

          <details class="report-detail" open>
            <summary>诊断树（通用）</summary>
            <div class="diag-tree">
              <div>现金流异常 → 收入下降 / 回款延迟 / 付款集中</div>
              <div>毛利下滑 → 价格下行 / 成本上升 / 费用抬升</div>
              <div>周转变慢 → 应收集中 / 付款过慢 / 库存积压</div>
              <div>集中度过高 → 客户/供应商备份不足</div>
            </div>
          </details>

          <details class="report-detail">
            <summary>口径&阈值（可折叠）</summary>
            <ul class="report-list" id="threshold_list">
              <li>加载中…</li>
            </ul>
          </details>

          <div class="report-conclusion-grid" id="sec0_conclusions"></div>
        </section>

        <section id="sec-1" class="report-section" data-route="report">
          <div class="section-head">
            <h2>1 经营摘要</h2>
            <div class="section-meta">16~20 个关键指标 + 预警灯 + 本期5条关键结论</div>
          </div>
          <div class="kpis report-kpis" id="exec_kpis"></div>
          <div class="report-grid report-grid-2 report-exec-grid">
            <div class="card report-card" id="warning_traffic_panel">
              <div class="report-card-title">红黄绿灯（点击跳转预警中心）</div>
              <div class="report-traffic">
                <button class="report-traffic-item level-red" id="traffic_red">
                  <span class="traffic-label">红</span>
                  <b id="traffic_red_count">—</b>
                </button>
                <button class="report-traffic-item level-yellow" id="traffic_yellow">
                  <span class="traffic-label">黄</span>
                  <b id="traffic_yellow_count">—</b>
                </button>
                <button class="report-traffic-item level-green" id="traffic_green">
                  <span class="traffic-label">绿</span>
                  <b id="traffic_green_count">—</b>
                </button>
              </div>
              <div class="report-mini-note">点击任意灯号自动滚动到预警中心。</div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">分部对比矩阵（全部/门店/非门店）</div>
              <div class="table-wrap dense-table">
                <div class="table-scroll report-table-scroll">
                  <table id="segment_matrix_table">
                    <thead>
                      <tr>
                        <th>分部</th>
                        <th>销售额</th>
                        <th>毛利额</th>
                        <th>毛利率</th>
                        <th>净现金流</th>
                        <th>净应收</th>
                        <th>净应付</th>
                        <th>库存</th>
                        <th>应收周转天数</th>
                        <th>应付周转天数</th>
                        <th>存货周转天数</th>
                        <th>现金转换周期</th>
                        <th>第一名集中度</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="report-subhead">本期5条关键结论</div>
          <div class="report-conclusion-grid" id="exec_conclusions"></div>
        </section>

        <section id="sec-2" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>2 收入与毛利</h2>
            <div class="section-meta">趋势 / 结构 / 异常订单</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">销售与毛利趋势</div>
              <div id="sales_trend_chart" class="plot-sm report-plot"></div>
              <div class="report-mini-note" id="sales_mom_text">加载中…</div>
              <div id="sales_mom_bridge" class="plot-xs report-plot"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">结构贡献头部</div>
              <div class="report-mini-tables">
                <div class="table-wrap dense-table">
                  <div class="report-table-title">头部品类</div>
                  <div class="table-scroll report-table-scroll">
                    <table id="sales_top_categories_table">
                      <thead>
                        <tr>
                          <th>品类</th>
                          <th>销售额</th>
                          <th>占比</th>
                          <th>毛利率</th>
                          <th>扣费毛利率</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
                <div class="table-wrap dense-table">
                  <div class="report-table-title">头部客户</div>
                  <div class="table-scroll report-table-scroll">
                    <table id="sales_top_customers_table">
                      <thead>
                        <tr>
                          <th>客户</th>
                          <th>销售额</th>
                          <th>占比</th>
                          <th>毛利率</th>
                          <th>扣费毛利率</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
                <div class="table-wrap dense-table">
                  <div class="report-table-title">头部产品</div>
                  <div class="table-scroll report-table-scroll">
                    <table id="sales_top_products_table">
                      <thead>
                        <tr>
                          <th>产品</th>
                          <th>销售额</th>
                          <th>占比</th>
                          <th>毛利率</th>
                          <th>扣费毛利率</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec2_conclusions"></div>
        </section>

        <section id="sec-3" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>3 现金流与收付匹配</h2>
            <div class="section-meta">银行维度 / 对账差异</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">期间现金流概览</div>
              <div class="report-kpi-row" id="cash_kpis"></div>
              <div id="cash_trend_chart" class="plot-sm report-plot"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">银行维度汇总</div>
              <div class="table-wrap dense-table">
                <div class="table-scroll report-table-scroll">
                  <table id="bank_type_table">
                    <thead>
                      <tr>
                        <th>类型</th>
                        <th>流入</th>
                        <th>流出</th>
                        <th>笔数</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="report-recon">
                <div class="report-mini-card" id="bank_recon_receipts"></div>
                <div class="report-mini-card" id="bank_recon_payments"></div>
              </div>
              <div class="report-recon-explain" id="bank_recon_explain">加载中…</div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec3_conclusions"></div>
        </section>

        <section id="sec-forecast" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>3A 预测与压力测试</h2>
            <div class="section-meta">未来30天现金流 / 策略可调参</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">预测动作包关键指标</div>
              <div class="report-action-toolbar">
                <label class="ctl">情景：
                  <select id="forecast_action_scenario">
                    <option value="base">基准</option>
                    <option value="s1">情景1（回款延迟）</option>
                  </select>
                </label>
              </div>
              <ul class="report-list">
                <li>缺口金额：<b id="forecast_action_gap">—</b></li>
                <li>动作覆盖率：<b id="forecast_action_cover">—</b></li>
                <li>头部动作释放现金：<b id="forecast_action_top">—</b></li>
              </ul>
              <div class="report-mini-note">用于检视动作包能否覆盖滚动30天缺口。</div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">行动清单锚点</div>
              <div class="report-mini-note">点击下方按钮跳转统一动作跟踪，并自动筛选预测来源。</div>
              <a class="btn" href="#sec-11" id="forecast_action_jump">查看预测行动清单</a>
            </div>
          </div>
          <details class="card report-card tuner-panel" open>
            <summary>预测策略调参器（预测策略可调参）</summary>
            <div class="tuner-grid">
              <div class="tuner-group">
                <div class="tuner-group-title">应收回款策略（影响未来流入）</div>
                <div class="tuner-row">
                  <label>未到期回款比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.collect_ratio_not_due" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.collect_ratio_not_due" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>1-30天回款比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.collect_ratio_1_30" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.collect_ratio_1_30" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>31-60天回款比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.collect_ratio_31_60" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.collect_ratio_31_60" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>61-90天回款比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.collect_ratio_61_90" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.collect_ratio_61_90" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>90天+回款比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.collect_ratio_90_plus" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.collect_ratio_90_plus" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>回款延迟比例（+7天）</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.delay_share_7d" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.delay_share_7d" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>回款延迟比例（+14天）</label>
                  <input type="range" class="tuner-input" data-tuner-path="ar.delay_share_14d" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ar.delay_share_14d" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>延迟适用账龄</label>
                  <select class="tuner-input" data-tuner-path="ar.delay_apply_to_bucket">
                    <option value="all">全部</option>
                    <option value="overdue_only">仅逾期</option>
                    <option value="31plus">31天+</option>
                  </select>
                  <div class="tuner-fixed">固定延迟：7天 / 14天</div>
                </div>
              </div>

              <div class="tuner-group">
                <div class="tuner-group-title">应付延付策略（影响未来流出）</div>
                <div class="tuner-row">
                  <label>可延付比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="ap.deferral_ratio" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ap.deferral_ratio" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>头部供应商延后天数</label>
                  <input type="range" class="tuner-input" data-tuner-path="ap.deferral_days_top_vendor" min="0" max="14"
                    step="1" />
                  <input type="number" class="tuner-input" data-tuner-path="ap.deferral_days_top_vendor" min="0"
                    max="14" step="1" />
                </div>
                <div class="tuner-row">
                  <label>其他供应商延后天数</label>
                  <input type="range" class="tuner-input" data-tuner-path="ap.deferral_days_other" min="0" max="21"
                    step="1" />
                  <input type="number" class="tuner-input" data-tuner-path="ap.deferral_days_other" min="0" max="21"
                    step="1" />
                </div>
                <div class="tuner-row">
                  <label>头部供应商阈值（付款占比）</label>
                  <input type="range" class="tuner-input" data-tuner-path="ap.top_vendor_threshold_ratio" min="0"
                    max="1" step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="ap.top_vendor_threshold_ratio" min="0"
                    max="1" step="0.05" />
                </div>
              </div>

              <div class="tuner-group">
                <div class="tuner-group-title">采购减采/暂停策略（影响估算流出）</div>
                <div class="tuner-row">
                  <label>基准/情景1/情景2 减采比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="po.reducible_ratio_base" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="po.reducible_ratio_base" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>情景3 减采比例</label>
                  <input type="range" class="tuner-input" data-tuner-path="po.reducible_ratio_S3" min="0" max="1"
                    step="0.05" />
                  <input type="number" class="tuner-input" data-tuner-path="po.reducible_ratio_S3" min="0" max="1"
                    step="0.05" />
                </div>
                <div class="tuner-row">
                  <label>应用范围</label>
                  <select class="tuner-input" data-tuner-path="po.apply_scope">
                    <option value="all">全部</option>
                    <option value="top_suppliers">头部供应商</option>
                    <option value="low_turnover_sku_if_available">低周转货号（如可用）</option>
                  </select>
                  <div class="tuner-fixed">按供应商/货号筛选</div>
                </div>
              </div>

              <div class="tuner-group">
                <div class="tuner-group-title">安全阈值（仅影响预警/动作触发）</div>
                <div class="tuner-row">
                  <label>缺口预警阈值（万）</label>
                  <input type="range" class="tuner-input" data-tuner-path="threshold.gap_amount_warn_wan" min="0"
                    max="500" step="10" />
                  <input type="number" class="tuner-input" data-tuner-path="threshold.gap_amount_warn_wan" min="0"
                    max="500" step="10" />
                </div>
                <div class="tuner-row">
                  <label>最低余额预警阈值（万）</label>
                  <input type="range" class="tuner-input" data-tuner-path="threshold.min_balance_warn_wan" min="0"
                    max="500" step="10" />
                  <input type="number" class="tuner-input" data-tuner-path="threshold.min_balance_warn_wan" min="0"
                    max="500" step="10" />
                </div>
              </div>
            </div>

            <div class="report-action-toolbar tuner-actions">
              <button class="btn btn-sm" id="tuner_apply_btn">应用参数</button>
              <button class="btn btn-sm" id="tuner_reset_btn">重置为默认</button>
              <button class="btn btn-sm" id="tuner_copy_btn">复制参数数据</button>
              <button class="btn btn-sm" id="tuner_export_btn">导出参数文件</button>
              <label class="btn btn-sm" for="tuner_import_input">导入参数文件</label>
              <input id="tuner_import_input" type="file" accept="application/json" class="hidden" />
              <button class="btn btn-sm" id="tuner_share_btn">生成分享链接</button>
            </div>

            <div class="tuner-summary">
              <div class="tuner-summary-card" id="tuner_base_summary">基准：—</div>
              <div class="tuner-summary-card" id="tuner_s1_summary">情景1：—</div>
              <div class="tuner-summary-card" id="tuner_action_coverage">动作覆盖率：—</div>
              <div class="tuner-summary-note" id="tuner_balance_note">余额口径：—</div>
            </div>
          </details>

          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">未来30天现金余额曲线</div>
              <div class="report-kpi-row" id="forecast_gap_kpis"></div>
              <div id="forecast_balance_chart" class="plot-sm report-plot"></div>
              <div class="report-mini-note" id="forecast_balance_hint">—</div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">策略影响速览</div>
              <div class="forecast-summary-grid">
                <div class="report-mini-card" id="forecast_base_card"></div>
                <div class="report-mini-card" id="forecast_s1_card"></div>
                <div class="report-mini-card" id="forecast_sensitivity_card"></div>
              </div>
              <div class="report-mini-note" id="forecast_sensitivity_note">—</div>
            </div>
          </div>
        </section>

        <section id="sec-risk" class="report-section" data-route="report">
          <div class="section-head">
            <h2>3B 风险中枢</h2>
            <div class="section-meta">现金流风险评分 / 异常检测</div>
          </div>
          <div class="risk-grid">
            <div class="risk-total">
              <div class="label">现金流风险评分（0-100，越高越危险）</div>
              <div class="value" id="risk_score_total">—</div>
              <div class="section-meta">评分=100-Σ扣分</div>
            </div>
            <div class="risk-kpi">
              <div class="label">未知项风险</div>
              <div class="value" id="risk_score_unknown">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">内部往来风险</div>
              <div class="value" id="risk_score_internal">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">集中度风险</div>
              <div class="value" id="risk_score_concentration">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">现金流波动风险</div>
              <div class="value" id="risk_score_volatility">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">对账差异风险</div>
              <div class="value" id="risk_score_recon">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">筹资风险</div>
              <div class="value" id="risk_score_financing">—</div>
            </div>
          </div>
          <div class="risk-action-coverage" id="risk_action_coverage">行动覆盖度：—</div>
          <div class="risk-grid risk-forecast-grid">
            <div class="risk-kpi">
              <div class="label">缺口风险</div>
              <div class="value" id="risk_score_gap">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">覆盖度风险</div>
              <div class="value" id="risk_score_coverage">—</div>
            </div>
            <div class="risk-kpi">
              <div class="label">情景敏感度风险</div>
              <div class="value" id="risk_score_sensitivity">—</div>
            </div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">风险评分图</div>
              <div id="risk_chart" class="risk-chart"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">扣分项明细</div>
              <div class="report-action-toolbar">
                <button class="btn btn-sm" id="export_risk_breakdown_btn">导出风险扣分明细</button>
              </div>
              <div class="table-wrap dense-table risk-table-wrap">
                <div class="table-scroll report-table-scroll">
                  <table class="risk-table">
                    <thead>
                      <tr>
                        <th>风险项</th>
                        <th>公式</th>
                        <th>阈值</th>
                        <th>当前值</th>
                        <th>扣分</th>
                        <th>证据</th>
                      </tr>
                    </thead>
                    <tbody id="risk_breakdown_body"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="card report-card">
            <div class="report-card-title">异常清单</div>
            <div class="risk-filters">
              <label class="ctl">类型
                <select id="risk_anomaly_type"></select>
              </label>
              <label class="ctl">严重度
                <select id="risk_anomaly_severity"></select>
              </label>
              <label class="ctl">分类
                <select id="risk_anomaly_class"></select>
              </label>
              <input id="risk_anomaly_search" type="text" placeholder="搜索对方/摘要" />
              <button class="btn btn-sm" id="export_anomalies_btn">导出异常清单</button>
              <button class="btn btn-sm" id="risk_anomaly_prev">上一页</button>
              <button class="btn btn-sm" id="risk_anomaly_next">下一页</button>
              <span class="risk-pagination" id="risk_anomaly_pagination"></span>
            </div>
            <div class="table-wrap dense-table anomaly-table-wrap">
              <div class="table-scroll report-table-scroll">
                <table class="risk-table">
                  <thead>
                    <tr>
                      <th>类型</th>
                      <th>严重度</th>
                      <th>日期</th>
                      <th>对方</th>
                      <th>摘要</th>
                      <th>金额</th>
                      <th>原因</th>
                      <th>建议动作</th>
                      <th>证据</th>
                    </tr>
                  </thead>
                  <tbody id="risk_anomaly_body"></tbody>
                </table>
              </div>
            </div>
            <div class="report-empty" id="risk_anomaly_empty"></div>
          </div>
        </section>


        <section id="sec-4" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>4 经营性应收</h2>
            <div class="section-meta">应收周转天数 / 集中度 / 停滞</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">应收指标</div>
              <div class="report-kpi-row" id="ar_kpis"></div>
              <div id="ar_trend_chart" class="plot-sm report-plot"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">头部客户（贸易应收）</div>
              <div class="table-wrap dense-table">
                <div class="table-scroll report-table-scroll">
                  <table id="ar_top_customers_table">
                    <thead>
                      <tr>
                        <th>客户</th>
                        <th>期末贸易应收</th>
                        <th>期末净应收</th>
                        <th>占比</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec4_conclusions"></div>
        </section>

        <section id="sec-5" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>5 其他应收（专项清理）</h2>
            <div class="section-meta">单列专项，不参与应收周转天数</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">原因分类模板</div>
              <div class="report-template">押金 / 往来 / 返利 / 代垫 / 员工借款 / 费用暂挂 / 其他</div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">清理路径</div>
              <div class="report-template">对账 → 确认 → 回收/冲抵 → 转长期/核销 → 月度跟踪</div>
            </div>
          </div>
          <div class="card report-card">
            <div class="report-card-title">头部其他应收客户</div>
            <div class="table-wrap dense-table">
              <div class="table-scroll report-table-scroll">
                <table id="other_ar_table">
                  <thead>
                    <tr>
                      <th>客户</th>
                      <th>其他应收余额</th>
                      <th>期末应收净额</th>
                      <th>动作建议</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec5_conclusions"></div>
        </section>

        <section id="sec-6" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>6 经营性应付</h2>
            <div class="section-meta">应付周转天数 / 集中度 / 停滞</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">应付指标</div>
              <div class="report-kpi-row" id="ap_kpis"></div>
              <div id="ap_trend_chart" class="plot-sm report-plot"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">头部供应商（采购应付）</div>
              <div class="table-wrap dense-table">
                <div class="table-scroll report-table-scroll">
                  <table id="ap_top_suppliers_table">
                    <thead>
                      <tr>
                        <th>供应商</th>
                        <th>采购应付余额</th>
                        <th>期末应付净额</th>
                        <th>占比</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec6_conclusions"></div>
        </section>

        <section id="sec-7" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>7 其他应付（专项清理）</h2>
            <div class="section-meta">单列专项，不参与应付周转天数</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">原因分类模板</div>
              <div class="report-template">押金 / 往来 / 返利 / 代垫 / 员工借款 / 费用暂挂 / 其他</div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">清理路径</div>
              <div class="report-template">对账 → 确认 → 冲抵/支付 → 转长期/核销 → 月度跟踪</div>
            </div>
          </div>
          <div class="card report-card">
            <div class="report-card-title">头部其他应付供应商</div>
            <div class="table-wrap dense-table">
              <div class="table-scroll report-table-scroll">
                <table id="other_ap_table">
                  <thead>
                    <tr>
                      <th>供应商</th>
                      <th>其他应付余额</th>
                      <th>期末应付净额</th>
                      <th>动作建议</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec7_conclusions"></div>
        </section>

        <section id="sec-8" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>8 库存与周转</h2>
            <div class="section-meta">存货周转天数 / 结构 / 滞销</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">库存指标</div>
              <div class="report-kpi-row" id="inventory_kpis"></div>
              <div id="inventory_trend_chart" class="plot-sm report-plot"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">库存诊断重点</div>
              <div class="report-text" id="inventory_focus">加载中…</div>
              <details class="report-detail" open>
                <summary>诊断树</summary>
                <div class="diag-tree">
                  <div>销量下降 → 需求滑落 / 价格偏离 / 客群变化</div>
                  <div>库存上升 → 采购节奏不匹配 / 滞销货号未清理</div>
                  <div>周转变慢 → 资金占用加剧 / 现金流承压</div>
                </div>
              </details>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec8_conclusions"></div>
        </section>

        <section id="sec-9" class="report-section" data-route="diagnose">
          <div class="section-head">
            <h2>9 采购与价格</h2>
            <div class="section-meta">采购单 / 成本趋势</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">采购指标</div>
              <div class="report-kpi-row" id="po_kpis"></div>
              <div class="report-card-title" id="po_price_title">关键货号价格走势</div>
              <div id="po_price_chart" class="plot-sm report-plot"></div>
            </div>
            <div class="card report-card">
              <div class="report-card-title">头部供应商（采购额）</div>
              <div class="table-wrap dense-table">
                <div class="table-scroll report-table-scroll">
                  <table id="po_top_suppliers_table">
                    <thead>
                      <tr>
                        <th>供应商</th>
                        <th>采购金额</th>
                        <th>占比</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="report-mini-note">价格趋势默认展示采购额最高的货号。</div>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec9_conclusions"></div>
        </section>

        <section id="sec-10" class="report-section" data-route="report">
          <div class="section-head">
            <h2>10 风险预警中心</h2>
            <div class="section-meta">规则引擎 + 诊断树</div>
          </div>
          <div class="report-grid report-grid-2">
            <div class="card report-card">
              <div class="report-card-title">规则引擎阈值</div>
              <ul class="report-list" id="warning_rules">
                <li>加载中…</li>
              </ul>
            </div>
            <div class="card report-card">
              <div class="report-card-title">预警统计</div>
              <div class="report-text" id="warning_stats">加载中…</div>
              <details class="report-detail" open>
                <summary>诊断树（模板）</summary>
                <div class="diag-tree">
                  <div>红色预警 → 现金/周转已冲击经营</div>
                  <div>黄色预警 → 指标偏离需重点跟踪</div>
                  <div>绿色预警 → 维持监控节奏</div>
                </div>
              </details>
            </div>
          </div>
          <div class="report-warning-filters">
            <label class="ctl">等级：
              <select id="warning_filter_level">
                <option value="all">全部</option>
                <option value="red">仅红</option>
                <option value="yellow">仅黄</option>
                <option value="green">仅绿</option>
              </select>
            </label>
            <label class="ctl">领域：
              <select id="warning_filter_domain">
                <option value="all">全部</option>
              </select>
            </label>
            <button class="btn btn-sm" id="warning_filter_reset">重置</button>
          </div>
          <div class="table-wrap dense-table">
            <div class="report-table-title">预警清单</div>
            <div class="table-scroll report-table-scroll">
              <table id="warning_table">
                <thead>
                  <tr>
                    <th>等级</th>
                    <th>领域</th>
                    <th>信号</th>
                    <th>证据</th>
                    <th>动作</th>
                    <th>证据链接</th>
                    <th>诊断树</th>
                  </tr>
                </thead>
                <tbody id="warning_table_body"></tbody>
              </table>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec10_conclusions"></div>
        </section>

        <section id="sec-11" class="report-section" data-route="report">
          <div class="section-head">
            <h2>11 动作清单</h2>
            <div class="section-meta">动作跟踪（自动汇总）</div>
          </div>
          <div class="report-action-toolbar">
            <label class="ctl">来源：
              <select id="action_filter_source">
                <option value="all">全部</option>
                <option value="risk">风险</option>
                <option value="cashflow">现金流</option>
                <option value="forecast">预测</option>
                <option value="margin">毛利</option>
              </select>
            </label>
            <button class="btn btn-sm" id="action_filter_reset">重置筛选</button>
            <button class="btn btn-sm" id="export_actions_forecast_btn">导出预测动作</button>
            <button class="btn btn-sm" id="export_actions_all_btn">导出全部动作</button>
            <button class="btn" id="copy_actions_btn">复制动作清单</button>
            <button class="btn" id="copy_warnings_btn">复制预警清单</button>
            <span class="report-mini-note" id="action_stats">加载中…</span>
          </div>
          <div class="table-wrap dense-table">
            <div class="table-scroll report-table-scroll">
              <table id="action_table">
                <thead>
                  <tr>
                    <th>来源</th>
                    <th>领域</th>
                    <th>结论/信号</th>
                    <th>负责人</th>
                    <th>动作</th>
                    <th>截止日期</th>
                    <th>预期影响</th>
                    <th>证据链接</th>
                  </tr>
                </thead>
                <tbody id="action_table_body"></tbody>
              </table>
            </div>
          </div>
          <div class="report-conclusion-grid" id="sec11_conclusions"></div>
        </section>

        <section id="route_explorer" class="report-section route-section" data-route="explorer">
          <div class="section-head">
            <h2>Dashboard Explorer</h2>
            <div class="section-meta">Sales / Finance / Forecast 明细同页探索与证据联动</div>
          </div>
          <div id="explorer_root" class="explorer-shell">
            <div class="explorer-bar">
              <div>
                <div class="title">经营分析 Explorer</div>
                <div class="subtitle">
                  数据范围：<b id="data_range">—</b>。版本：<b id="page_version">—</b>。
                  <div class="explorer-note">提示：全局筛选影响图表与汇总；表内筛选仅影响当前表。</div>
                  <div id="data_status"></div>
                </div>
              </div>
              <div class="explorer-actions">
                <button class="btn btn-sm" id="explorer_reset_btn">重置筛选</button>
                <button class="btn btn-sm" id="explorer_copy_link_btn">复制当前视图链接</button>
              </div>
            </div>
            <div class="explorer-filters controls">
              <label class="ctl">分部
                <select id="explorer_segment">
                  <option value="total">全部</option>
                  <option value="store">门店</option>
                  <option value="nonstore">非门店</option>
                </select>
              </label>
              <label class="ctl">开始日
                <input id="explorer_date_start" type="date" />
              </label>
              <label class="ctl">结束日
                <input id="explorer_date_end" type="date" />
              </label>
              <label class="ctl">客户
                <input id="explorer_filter_customer" type="text" placeholder="客户名/编码" />
              </label>
              <label class="ctl">供应商
                <input id="explorer_filter_vendor" type="text" placeholder="供应商" />
              </label>
              <label class="ctl">SKU
                <input id="explorer_filter_sku" type="text" placeholder="SKU/货号" />
              </label>
              <label class="ctl">品类
                <input id="explorer_filter_category" type="text" placeholder="品类" />
              </label>
              <label class="ctl">毛利口径
                <select id="explorer_filter_margin">
                  <option value="WAC">WAC</option>
                  <option value="LPP_PERIOD_END">期末价</option>
                  <option value="LPP_ASOF_SALE">销售时点</option>
                </select>
              </label>
              <label class="ctl">情景
                <select id="explorer_filter_scenario">
                  <option value="BASE">BASE</option>
                  <option value="S1">S1</option>
                  <option value="S2">S2</option>
                  <option value="S3">S3</option>
                </select>
              </label>
            </div>

            <div class="explorer-anchors">
              <div id="explorer_sales"></div>
              <div id="explorer_finance"></div>
              <div id="explorer_forecast"></div>
            </div>

            <div class="seg-switch">
              <button class="segbtn active" data-seg="total">全部</button>
              <button class="segbtn" data-seg="store">超群门店</button>
              <button class="segbtn" data-seg="nonstore">非超群门店</button>
            </div>

            <div class="seg active" id="seg_total"></div>
            <div class="seg" id="seg_store"></div>
            <div class="seg" id="seg_nonstore"></div>

            <div id="explorer_detail_panel" class="detail-panel hidden" aria-hidden="true">
              <div class="detail-head">
                <div class="detail-title" id="detail_title">明细详情</div>
                <button class="btn btn-sm" id="detail_close_btn">关闭</button>
              </div>
              <div class="detail-body" id="detail_body"></div>
            </div>

            <div id="order_modal" class="modal" aria-hidden="true" onclick="if(event.target===this) closeOrderModal()">
              <div class="modal-wrap" role="dialog" aria-modal="true">
                <div class="modal-hd">
                  <div class="modal-title">
                    <span id="order_modal_title_text">订单明细</span>
                    <span id="order_modal_meta" class="meta"></span>
                  </div>
                  <button class="modal-close" onclick="closeOrderModal()" aria-label="关闭">×</button>
                </div>
                <div class="modal-bd">
                  <div class="order-tools">
                    <div class="order-search">
                      <input id="order_modal_search" type="text" placeholder="搜索订单编号（支持模糊匹配）" />
                      <button class="btn btn-sm" onclick="clearOrderModalSearch()">清空</button>
                    </div>
                    <div class="order-btns">
                      <button class="btn" onclick="copyOrderModal()">复制（当前筛选）</button>
                      <button class="btn" onclick="copyOrderModal(true)">复制全部</button>
                      <button class="btn" onclick="closeOrderModal()">关闭</button>
                    </div>
                  </div>
                  <div id="order_modal_list" class="order-grid"></div>
                  <div class="order-foot">
                    <span>提示：点击单个订单编号可复制。</span>
                    <span id="order_modal_count"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="route_bp" class="report-section route-section" data-route="bp">
          <div class="section-head">
            <h2>BP 报告</h2>
            <div class="section-meta">预算正文视图 / 目录 / 搜索 / 打印</div>
          </div>
          <div class="bp-shell">
            <div class="bp-toolbar">
              <div class="bp-title" id="bp_title">财务预算报告</div>
              <div class="bp-actions">
                <input id="bp_search" type="search" placeholder="搜索 BP 正文…" />
                <button class="btn btn-sm" id="bp_search_btn">搜索</button>
                <button class="btn btn-sm" id="bp_clear_btn">清空</button>
                <button class="btn" id="bp_print_btn">打印 BP</button>
              </div>
            </div>
            <div class="bp-layout">
              <aside class="bp-toc" id="bp_toc"></aside>
              <div class="bp-content" id="bp_root">加载 BP 正文…</div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <aside class="evidence-drawer closed" id="evidence_drawer" aria-hidden="true">
      <div class="drawer-head">
        <div>
          <div class="drawer-title">Evidence Drawer</div>
          <div class="drawer-subtitle" id="drawer_subtitle">选择结论/指标查看证据</div>
        </div>
        <div class="drawer-actions">
          <button class="btn btn-sm" id="drawer_pin_btn">Pin</button>
          <button class="btn btn-sm" id="drawer_close_btn">关闭</button>
        </div>
      </div>
      <div class="drawer-tabs" id="drawer_tabs"></div>
      <div class="drawer-body" id="drawer_body">
        <div class="drawer-empty" id="drawer_empty">暂无证据。点击“查看证据”触发。</div>
      </div>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

  <div id="export_center" class="export-center hidden" aria-hidden="true">
    <div class="export-panel">
      <div class="export-title">导出中心</div>
      <div class="export-grid">
        <button class="btn" data-export="summary_csv">导出汇总 CSV</button>
        <button class="btn" data-export="detail_csv">导出明细 CSV</button>
        <button class="btn" data-export="actions_csv">导出动作清单 CSV</button>
        <button class="btn btn-ghost" data-export="snapshot_json">下载摘要 JSON</button>
      </div>
      <div class="export-foot">
        <button class="btn btn-sm" id="export_close_btn">关闭</button>
      </div>
    </div>
  </div>

  <div id="anomaly_modal" class="modal" aria-hidden="true" onclick="if(event.target===this) closeAnomalyModal()">
    <div class="modal-wrap" role="dialog" aria-modal="true">
      <div class="modal-hd">
        <div class="modal-title">
          <span id="anomaly_modal_title">异常明细</span>
          <span class="meta" id="anomaly_modal_meta"></span>
        </div>
        <button class="modal-close" onclick="closeAnomalyModal()" aria-label="关闭">×</button>
      </div>
      <div class="modal-bd">
        <div id="anomaly_modal_body" class="kpi-detail-summary"></div>
      </div>
    </div>
  </div>

  <div id="kpi_detail_modal" class="modal" aria-hidden="true">
    <div class="modal-wrap" role="dialog" aria-modal="true">
      <div class="modal-hd">
        <div class="modal-title">
          <span id="kpi_detail_title">指标详情</span>
          <span class="meta" id="kpi_detail_meta"></span>
        </div>
        <button class="modal-close" id="kpi_detail_close" aria-label="关闭">×</button>
      </div>
      <div class="modal-bd">
        <div id="kpi_detail_summary" class="kpi-detail-summary"></div>
        <div class="kpi-detail-table-wrap" id="kpi_detail_table_wrap">
          <table class="kpi-detail-table" id="kpi_detail_table">
            <thead>
              <tr>
                <th>月份</th>
                <th>数值</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="kpi_detail_empty" class="report-empty hidden">暂无明细数据</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" defer></script>
  <script src="./charts.js" defer></script>
  <script src="./js/modules/data_loader.js" defer></script>
  <script src="./js/modules/state_manager.js" defer></script>
  <script src="./js/modules/router.js" defer></script>
  <script src="./js/modules/evidence_drawer.js" defer></script>
  <script src="./js/modules/explorer_sales.js" defer></script>
  <script src="./js/modules/explorer_finance.js" defer></script>
  <script src="./js/modules/bp_view.js" defer></script>
  <script src="./js/modules/export_center.js" defer></script>
  <script src="./ui.js" defer></script>
  <script src="./finance.js" defer></script>
  <script src="./app.js" defer></script>
  <!-- COMMENTED OUT: This script conflicts with app.js - both try to load data independently -->
  <!-- <script src="./js/report.js" defer></script> -->
</body>

</html>