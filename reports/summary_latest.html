<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<base href="../"/>
<title>管理层汇总</title>
<link rel="stylesheet" href="./styles.css"/>
<style>
  .summary-section{margin-top:16px;}
  .summary-list{margin:8px 0 0;padding-left:18px;}
  .summary-list li{margin:6px 0;}
  .summary-note{font-size:12px;color:var(--muted);font-weight:700;margin-top:4px;}
  .summary-tables{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px;}
  .summary-links{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
  .summary-links .bp-link{font-size:13px;}
  @media (max-width:960px){
    .summary-tables{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div id="loading_state" class="state">
  <div class="state-card">
    <div class="state-spinner"></div>
    <div class="state-title">数据加载中…</div>
    <div class="state-msg">正在拉取 ./data/latest.json 与 ./data/finance_latest.json</div>
  </div>
</div>

<div id="error_state" class="state hidden">
  <div class="state-card">
    <div class="state-title">数据加载失败</div>
    <div id="error_message" class="state-msg"></div>
    <button id="reload_btn" class="btn">重新加载</button>
  </div>
</div>

<div class="container">
  <div class="title">管理层汇总</div>
  <div class="subtitle">
    数据范围：<b id="summary_range">—</b> ｜ 销售版本：<b id="summary_sales_version">—</b> ｜ 财务版本：<b id="summary_finance_version">—</b> ｜ 币种：<b id="summary_currency">—</b>
    <div class="summary-links">
      <a class="bp-link" href="./index.html" target="_blank" rel="noopener">打开经营分析主页</a>
      <a class="bp-link" href="./reports/bp_latest.html" target="_blank" rel="noopener">查看财务BP报告</a>
    </div>
  </div>

  <div class="card summary-section">
    <div class="finance-block-hd">
      <div>
        <div class="finance-title">销售概览</div>
        <div class="finance-meta">销售额 / 毛利 / 毛利率（来自 latest.json）</div>
      </div>
    </div>
    <div class="kpis" id="summary_sales_kpis"></div>
    <ul class="summary-list" id="summary_sales_insights"></ul>
  </div>

  <div class="card summary-section">
    <div class="finance-block-hd">
      <div>
        <div class="finance-title">财务概览</div>
        <div class="finance-meta">贸易口径周转 + 余额 + 现金流</div>
      </div>
    </div>
    <div class="finance-kpis" id="summary_finance_kpis"></div>
    <ul class="summary-list" id="summary_finance_insights"></ul>
  </div>

  <div class="card summary-section">
    <div class="finance-block-hd">
      <div>
        <div class="finance-title">专项清理（其他应收 / 其他应付）</div>
        <div class="finance-meta">单列清理，不参与周转口径</div>
      </div>
    </div>
    <div class="summary-note">说明：以下 Top 清单用于专项核对与清理，不纳入 DSO/DPO 计算。</div>
    <ul class="summary-list" id="summary_special_insights"></ul>
    <div class="summary-tables">
      <div class="table-wrap finance-table">
        <div class="controls finance-controls">
          <div class="finance-table-title">Top 其他应收</div>
          <span class="count">显示：<b id="summary_other_ar_count">0</b></span>
        </div>
        <div class="table-scroll" style="max-height:360px;">
          <table id="summary_other_ar_table">
            <thead><tr>
              <th>客户</th>
              <th>其他应收余额</th>
              <th>期末应收净额</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="table-wrap finance-table">
        <div class="controls finance-controls">
          <div class="finance-table-title">Top 其他应付</div>
          <span class="count">显示：<b id="summary_other_ap_count">0</b></span>
        </div>
        <div class="table-scroll" style="max-height:360px;">
          <table id="summary_other_ap_table">
            <thead><tr>
              <th>供应商</th>
              <th>其他应付余额</th>
              <th>期末应付净额</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const ROW_IDX={
    date:0,
    order:1,
    cust:2,
    cls:3,
    name:4,
    spec:5,
    prod:6,
    cat:7,
    qty:8,
    sales:9,
    cost:10,
    fee:11,
    gp:12,
    gpAdj:13,
    unitPrice:14
  };

  function toNumber(val){
    if(val === null || val === undefined || val === '') return null;
    const n = Number(val);
    return isFinite(n) ? n : null;
  }

  function fmtWanSafe(val){
    const n = toNumber(val);
    if(n === null) return '—';
    return (n / 10000).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' 万';
  }

  function fmtPctSafe(val){
    const n = toNumber(val);
    if(n === null) return '—';
    return n.toFixed(2) + '%';
  }

  function fmtDays(val){
    const n = toNumber(val);
    if(n === null) return '—';
    const v = Math.round(n * 10) / 10;
    const digits = v % 1 ? 1 : 0;
    return v.toLocaleString('en-US', {minimumFractionDigits:digits, maximumFractionDigits:1});
  }

  function fmtText(val){
    if(val === null || val === undefined) return '—';
    const s = String(val).trim();
    return s ? s : '—';
  }

  function fmtYi(val){
    const n = toNumber(val);
    if(n === null) return '—';
    return (n/1e8).toFixed(3) + ' 亿';
  }

  function parseJsonWithNaN(text){
    if(text.indexOf('NaN') === -1) return JSON.parse(text);
    let out = '';
    let inStr = false;
    let escape = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      if(inStr){
        out += ch;
        if(escape){
          escape = false;
        }else if(ch === '\\'){
          escape = true;
        }else if(ch === '"'){
          inStr = false;
        }
        continue;
      }
      if(ch === '"'){
        inStr = true;
        out += ch;
        continue;
      }
      if(ch === 'N' && text.slice(i, i + 3) === 'NaN'){
        out += 'null';
        i += 2;
        continue;
      }
      out += ch;
    }
    return JSON.parse(out);
  }

  function getDataUrl(){
    const base = './data/latest.json';
    const joiner = base.includes('?') ? '&' : '?';
    return base + joiner + 'v=' + Date.now();
  }

  function getFinanceUrl(){
    const base = './data/finance_latest.json';
    const joiner = base.includes('?') ? '&' : '?';
    return base + joiner + 'v=' + Date.now();
  }

  function setLoadingState(show, msg){
    const el = document.getElementById('loading_state');
    if(!el) return;
    el.classList.toggle('hidden', !show);
    if(msg){
      const msgEl = el.querySelector('.state-msg');
      if(msgEl) msgEl.textContent = msg;
    }
  }

  function setErrorState(show, msg){
    const el = document.getElementById('error_state');
    if(!el) return;
    el.classList.toggle('hidden', !show);
    const msgEl = document.getElementById('error_message');
    if(msgEl) msgEl.textContent = msg || '请检查网络或数据文件路径。';
  }

  function buildKpiCard(label, value, sub){
    const card = document.createElement('div');
    card.className = 'card';
    const name = document.createElement('div');
    name.className = 'kpi-name';
    name.textContent = label;
    const val = document.createElement('div');
    val.className = 'kpi-val';
    val.textContent = value;
    if(sub){
      const span = document.createElement('span');
      span.className = 'kpi-sub';
      span.textContent = sub;
      val.appendChild(span);
    }
    card.appendChild(name);
    card.appendChild(val);
    return card;
  }

  function renderKpis(containerId, items){
    const el = document.getElementById(containerId);
    if(!el) return;
    const frag = document.createDocumentFragment();
    (items || []).forEach(item=>{
      frag.appendChild(buildKpiCard(item.label, item.value, item.sub));
    });
    el.replaceChildren(frag);
  }

  function addInsight(listId, text){
    const el = document.getElementById(listId);
    if(!el) return;
    const li = document.createElement('li');
    li.textContent = text;
    el.appendChild(li);
  }

  function renderTable(tableId, rows, columns, formatters, countId){
    const table = document.getElementById(tableId);
    if(!table || !table.tBodies || !table.tBodies[0]) return;
    const tbody = table.tBodies[0];
    tbody.innerHTML = '';

    if(!Array.isArray(rows) || rows.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = columns.length;
      td.className = 'finance-empty-row';
      td.textContent = '暂无数据';
      tr.appendChild(td);
      tbody.appendChild(tr);
      const countEl = document.getElementById(countId);
      if(countEl) countEl.textContent = '0';
      return;
    }

    rows.forEach(row=>{
      const tr = document.createElement('tr');
      columns.forEach((col, idx)=>{
        const td = document.createElement('td');
        const val = row && row[col.key] !== undefined ? row[col.key] : null;
        const fmt = formatters && typeof formatters[idx] === 'function' ? formatters[idx] : null;
        td.textContent = fmt ? fmt(val, row) : fmtText(val);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    const countEl = document.getElementById(countId);
    if(countEl) countEl.textContent = String(rows.length);
  }

  function sumByKey(rows, keyIdx){
    const map = new Map();
    rows.forEach(r=>{
      const key = r && r[keyIdx] ? String(r[keyIdx]) : '';
      if(!key) return;
      if(!map.has(key)) map.set(key, {key, sales:0, gpAdj:0});
      const o = map.get(key);
      o.sales += Number(r[ROW_IDX.sales]) || 0;
      o.gpAdj += Number(r[ROW_IDX.gpAdj]) || 0;
    });
    const arr = [...map.values()];
    arr.forEach(o=>{o.gmAdj = o.sales ? o.gpAdj / o.sales * 100 : null;});
    arr.sort((a,b)=>(b.gpAdj||0)-(a.gpAdj||0));
    return arr;
  }

  function deriveDateRange(rows){
    const dates = rows.map(r=>r && r[ROW_IDX.date]).filter(Boolean).sort();
    if(!dates.length) return '—';
    return dates[0] + ' 至 ' + dates[dates.length - 1];
  }

  function safeText(val){
    const s = fmtText(val);
    return s === '—' ? '—' : s;
  }

  function renderSummary(data, finance){
    const rows = (data && data.total && Array.isArray(data.total.rows)) ? data.total.rows : [];
    const sales = rows.reduce((sum, r)=>sum + (Number(r[ROW_IDX.sales]) || 0), 0);
    const gp = rows.reduce((sum, r)=>sum + (Number(r[ROW_IDX.gp]) || 0), 0);
    const gpAdj = rows.reduce((sum, r)=>sum + (Number(r[ROW_IDX.gpAdj]) || 0), 0);
    const gm = sales ? gp / sales * 100 : null;
    const gmAdj = sales ? gpAdj / sales * 100 : null;

    const rangeText = deriveDateRange(rows);
    const salesVersion = data && data.generatedAt ? data.generatedAt : '';
    const financeMeta = finance && finance.meta ? finance.meta : {};
    const financeVersion = financeMeta.generated_at || financeMeta.generatedAt || '';
    const currency = financeMeta.currency ? financeMeta.currency : '—';

    const rangeEl = document.getElementById('summary_range');
    if(rangeEl) rangeEl.textContent = rangeText;
    const salesVerEl = document.getElementById('summary_sales_version');
    if(salesVerEl) salesVerEl.textContent = salesVersion || '—';
    const finVerEl = document.getElementById('summary_finance_version');
    if(finVerEl) finVerEl.textContent = financeVersion || '—';
    const curEl = document.getElementById('summary_currency');
    if(curEl) curEl.textContent = currency || '—';

    renderKpis('summary_sales_kpis', [
      { label:'销售额（含税）', value: fmtWanSafe(sales), sub: fmtYi(sales) },
      { label:'毛利', value: fmtWanSafe(gp) },
      { label:'综合毛利率', value: fmtPctSafe(gm) },
      { label:'毛利-销售费', value: fmtWanSafe(gpAdj) },
      { label:'毛利率（扣费）', value: fmtPctSafe(gmAdj) }
    ]);

    const catList = sumByKey(rows, ROW_IDX.cat);
    const custList = sumByKey(rows, ROW_IDX.cust);
    const topCat = catList[0];
    const topCust = custList[0];
    const topCatShare = topCat && gpAdj ? (topCat.gpAdj / gpAdj * 100) : null;
    const topCustShare = topCust && gpAdj ? (topCust.gpAdj / gpAdj * 100) : null;

    addInsight('summary_sales_insights',
      `证据：销售额${fmtWanSafe(sales)}，综合毛利率${fmtPctSafe(gm)}；建议：对低毛利品类/客户做价格与费用复盘，避免毛利率继续下滑。`
    );

    addInsight('summary_sales_insights',
      `证据：品类Top1 ${safeText(topCat && topCat.key)} 毛利_扣费${fmtWanSafe(topCat && topCat.gpAdj)}（占比${fmtPctSafe(topCatShare)}）；建议：保障核心品类供给与价格稳定，并复制打法到次梯队。`
    );

    addInsight('summary_sales_insights',
      `证据：客户Top1 ${safeText(topCust && topCust.key)} 毛利_扣费${fmtWanSafe(topCust && topCust.gpAdj)}（占比${fmtPctSafe(topCustShare)}）；建议：强化回款与续约机制，降低集中度风险。`
    );

    const wc = finance && finance.wc ? finance.wc : {};
    const wcKpi = wc && wc.kpi ? wc.kpi : {};
    const arSeg = finance && finance.ar && finance.ar.segments ? finance.ar.segments.total : (finance && finance.ar ? finance.ar : {});
    const arKpi = arSeg && arSeg.kpi ? arSeg.kpi : {};
    const ap = finance && finance.ap ? finance.ap : {};
    const apKpi = ap && ap.kpi ? ap.kpi : {};
    const inv = finance && finance.inventory ? finance.inventory : {};
    const invKpi = inv && inv.kpi ? inv.kpi : {};
    const bank = finance && finance.bank ? finance.bank : {};
    const bankKpi = bank && bank.kpi ? bank.kpi : {};

    renderKpis('summary_finance_kpis', [
      { label:'DSO(天)', value: fmtDays(wcKpi.dso_days_est) },
      { label:'DIO(天)', value: fmtDays(wcKpi.dio_days_est) },
      { label:'DPO(天)', value: fmtDays(wcKpi.dpo_days_est) },
      { label:'CCC(天)', value: fmtDays(wcKpi.ccc_days_est) },
      { label:'贸易应收余额', value: fmtWanSafe(arKpi.ending_sales_ar) },
      { label:'贸易应付余额', value: fmtWanSafe(apKpi.ending_purchase_ap) },
      { label:'期末库存', value: fmtWanSafe(invKpi.inventory_end) },
      { label:'期间净现金流', value: fmtWanSafe(bankKpi.period_net_cash) }
    ]);

    addInsight('summary_finance_insights',
      `证据：DSO ${fmtDays(wcKpi.dso_days_est)} / DIO ${fmtDays(wcKpi.dio_days_est)} / DPO ${fmtDays(wcKpi.dpo_days_est)} / CCC ${fmtDays(wcKpi.ccc_days_est)}；建议：以回款与库存去化为主，控制 CCC 上行。`
    );

    addInsight('summary_finance_insights',
      `证据：贸易应收${fmtWanSafe(arKpi.ending_sales_ar)}、贸易应付${fmtWanSafe(apKpi.ending_purchase_ap)}、期末库存${fmtWanSafe(invKpi.inventory_end)}；建议：匹配采购与销售节奏，减少占用资金。`
    );

    const netCash = toNumber(bankKpi.period_net_cash);
    const netCashHint = netCash !== null && netCash < 0 ? '建议：安排回款与压缩非关键支出，优先修复净现金流。' : '建议：持续优化收付节奏，稳定现金流。';
    addInsight('summary_finance_insights',
      `证据：期间净现金流${fmtWanSafe(bankKpi.period_net_cash)}；${netCashHint}`
    );

    const otherAr = Array.isArray(arSeg && arSeg.top_other_ar_customers) ? arSeg.top_other_ar_customers : [];
    const otherAp = Array.isArray(ap && ap.top_other_ap_suppliers) ? ap.top_other_ap_suppliers : [];
    const otherArTotal = otherAr.reduce((sum, r)=>sum + (Number(r.ending_other_ar) || 0), 0);
    const otherApTotal = otherAp.reduce((sum, r)=>sum + (Number(r.ending_other_ap) || 0), 0);

    addInsight('summary_special_insights',
      `证据：其他应收Top${otherAr.length || 0}合计${fmtWanSafe(otherArTotal)}，其他应付Top${otherAp.length || 0}合计${fmtWanSafe(otherApTotal)}；建议：按客户/供应商逐项对账清理，制定回收与挂账冲销计划。`
    );

    renderTable('summary_other_ar_table', otherAr, [
      { key:'customer' },
      { key:'ending_other_ar' },
      { key:'ending_net_ar' }
    ], [
      (v)=>fmtText(v),
      (v)=>fmtWanSafe(v),
      (v)=>fmtWanSafe(v)
    ], 'summary_other_ar_count');

    renderTable('summary_other_ap_table', otherAp, [
      { key:'supplier' },
      { key:'ending_other_ap' },
      { key:'ending_net_ap' }
    ], [
      (v)=>fmtText(v),
      (v)=>fmtWanSafe(v),
      (v)=>fmtWanSafe(v)
    ], 'summary_other_ap_count');
  }

  async function loadAll(){
    setErrorState(false, '');
    setLoadingState(true, '正在拉取 ./data/latest.json 与 ./data/finance_latest.json');
    try{
      const [dataResp, financeResp] = await Promise.all([
        fetch(getDataUrl(), { cache:'no-store' }),
        fetch(getFinanceUrl(), { cache:'no-store' })
      ]);

      if(!dataResp.ok) throw new Error('销售数据文件加载失败: HTTP ' + dataResp.status);
      if(!financeResp.ok) throw new Error('财务数据文件加载失败: HTTP ' + financeResp.status);

      const dataText = await dataResp.text();
      const financeText = await financeResp.text();
      const data = parseJsonWithNaN(dataText);
      const finance = parseJsonWithNaN(financeText);

      renderSummary(data, finance);
      setLoadingState(false, '');
    }catch(err){
      setLoadingState(false, '');
      setErrorState(true, err && err.message ? err.message : '数据加载失败');
    }
  }

  const reloadBtn = document.getElementById('reload_btn');
  if(reloadBtn){
    reloadBtn.addEventListener('click', loadAll);
  }

  loadAll();
})();
</script>
</body>
</html>
